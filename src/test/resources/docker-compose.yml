version: "3.7"
services:
#  aggregate-trace:
#    image: "ianitrix/kafka:latest"
#    networks:
#      - confluent
#    command: "kafka-producer-perf-test --topic test --num-records 1000000 --throughput 1 --record-size 100 --producer-props interceptor.classes=org.ianitrix.kafka.interceptors.ProducerTracingInterceptor bootstrap.servers=kafka:9092 client.id=myProducer"
#    volumes:
#      - ../../../target/tracing-interceptors-0.0.1-SNAPSHOT-jar-with-dependencies.jar:/confluent-5.4.0/share/java/kafka/tracing-interceptors.jar:ro
#    depends_on:
#      - kafka
#    restart: on-failure

  elasticsearch:
    image: "elasticsearch:7.6.1"
    hostname: elasticsearch
    environment:
      - node.name=elasticsearch
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=elasticsearch
      - cluster.initial_master_nodes=elasticsearch
      - bootstrap.memory_lock=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    networks:
      - elastic

  kibana:
    image: "kibana:7.6.1"
    hostname: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - 5601:5601
    depends_on:
      - elasticsearch
    networks:
      - elastic

  kafka-connect:
    image: "confluentinc/cp-kafka-connect:5.4.1"
    hostname: kafka-connect
    ports:
      - 8083:8083
    networks:
      - elastic
    environment:
      - "KAFKA_HEAP_OPTS=-Xms512m -Xmx512m"
      - "CONNECT_BOOTSTRAP_SERVERS=kafka:9092"
      - "CONNECT_REST_PORT=8083"
      - "CONNECT_GROUP_ID=connect"
      - "CONNECT_CONFIG_STORAGE_TOPIC=_connect-config"
      - "CONNECT_OFFSET_STORAGE_TOPIC=_connect-offsets"
      - "CONNECT_STATUS_STORAGE_TOPIC=_connect-status"
      - "CONNECT_REPLICATION_FACTOR=1"
      - "CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR=1"
      - "CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR=1"
      - "CONNECT_STATUS_STORAGE_REPLICATION_FACTOR=1"
      - "CONNECT_KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter"
      - "CONNECT_VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter"
      - "CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE=false"
      - "CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE=false"
      - "CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL=http://schema-registry:8081"
      - "CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL=http://schema-registry:8081"
      - "CONNECT_INTERNAL_KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter"
      - "CONNECT_INTERNAL_VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter"
      - "CONNECT_REST_ADVERTISED_HOST_NAME=kafka-connect"
      - "CONNECT_PLUGIN_PATH=/usr/share/java"
      - "CONNECT_LOG4J_ROOT_LOGLEVEL=INFO"
      -  "CONNECT_LOG4J_LOGGERS=org.reflections=ERROR"
    restart: on-failure

  load-es-connector-trace:
    image: "curlimages/curl:7.69.0"
    hostname: curl
    command: >
      curl -XPOST -H "Content-Type: application/json" http://kafka-connect:8083/connectors -d '
        {
           "name":"aggregatedTrace",
           "config": {
             "connector.class":"ElasticsearchSinkConnector",
             "name":"aggregatedTrace",
             "connection.url":"http://elasticsearch:9200",
             "type.name":"trace",
             "topics":"_aggregatedTrace",
             "auto.create.indices.at.start": false,
             "key.ignore": "true",
             "schema.ignore":true,
             "transforms":"topic",
             "transforms.topic.regex":".*",
             "transforms.topic.type":"org.apache.kafka.connect.transforms.RegexRouter",
             "transforms.topic.replacement":"trace",
             "errors.tolerance":"none",
             "errors.retry.timeout":-1
           }}'
    depends_on:
      - kafka-connect
    networks:
      - elastic
    restart: on-failure

  load-es-connector-raw:
    image: "curlimages/curl:7.69.0"
    hostname: curl
    command: >
      curl -XPOST -H "Content-Type: application/json" http://kafka-connect:8083/connectors -d '
        {
           "name":"rawTrace",
           "config": {
             "connector.class":"ElasticsearchSinkConnector",
             "name":"rawTrace",
             "connection.url":"http://elasticsearch:9200",
             "type.name":"trace",
             "topics":"_tracing",
             "auto.create.indices.at.start": false,
             "key.ignore": "true",
             "schema.ignore":true,
             "transforms":"topic",
             "transforms.topic.regex":".*",
             "transforms.topic.type":"org.apache.kafka.connect.transforms.RegexRouter",
             "transforms.topic.replacement":"rawTrace",
             "errors.tolerance":"none",
             "errors.retry.timeout":-1
           }}'
    depends_on:
      - kafka-connect
    networks:
      - elastic
    restart: on-failure

  load-kibana-dashboard:
    image: "curlimages/curl:7.69.0"
    hostname: curl
    command: "curl -X POST 'http://kibana:5601/api/saved_objects/_import' -H 'kbn-xsrf: true' --form file=@kibana.ndjson"
    depends_on:
      - kibana
    networks:
      - elastic
    restart: on-failure
    volumes:
      - ./kibana.ndjson:/kibana.ndjson:ro

networks:
  elastic:
    external:
      name: confluent
